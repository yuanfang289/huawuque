<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>预约参观</title>
    @import "meta.tpl"
    <link rel="stylesheet" href="/assets/public/plugins/mobiscroll/styles/mobiscroll.css">
    <link rel="stylesheet" href="/assets/public/visitor/styles/baseform.css">
</head>
<body>
<input type="hidden" name="appSource" value="">
<!-- wrapper -->
<div class="wrapper">
    <!-- header -->
    <header id="header" class="header-def">
        <!-- titlebar -->
        <div id="titlebar">
            <i class="nav-switch uricon-arrow-left" id="backOrClose"></i>
            <span class="title">预约参观</span>
        </div>
        <!-- / titlebar -->
    </header>
    <!-- / header -->
    <!-- main -->
    <main id="main">
        <form class="form form-primary form-def">
            <div class="form-scroll">
                <div class="form-item">
                    <label class="form-label">预约人</label>
                    <div class="form-cont">
                        <i class="uricon-arrow-right ricon"></i>
                        <input type="hidden" name="name" value="" placeholder="必填" />
                        <a href="javascript:;" class="readonly-text input-editor" data-target="#editor" data-options="
                            mode: 'input',
                            name: 'name',
                            label: '姓名',
                            type: 'text',
                            rules: {
                                maxlength: 20
                            },
                            messages: {
                                maxlength: '最多20个字'
                            }
                        "></a>
                    </div>
                </div>

                <div class="form-item form-item-telphone">
                    <label class="form-label">联系电话</label>
                    <div class="form-cont">
                        <i class="uricon-arrow-right ricon"></i>
                        <input type="hidden" name="mobile" value="" placeholder="必填" />
                        <a href="javascript:;" id="mobile_dummy" class="readonly-text input-editor" data-target="#editor" data-options="
                            mode: 'input',
                            name: 'mobile',
                            label: '手机号码',
                            type: 'tel',
                            rules: {
                                phone: true
                            },
                            messages: {
                                phone: '手机格式不正确'
                            }
                        "></a>
                    </div>
                </div>

                <div class="form-item form-bottom">
                    <label class="form-label">公司名称</label>
                    <div class="form-cont">
                        <i class="uricon-arrow-right ricon"></i>
                        <input type="hidden" name="company" value="" placeholder="必填" />
                        <a href="javascript:;" class="readonly-text input-editor" data-target="#editor" data-options="
                            mode: 'input',
                            name: 'company',
                            label: '公司名称',
                            type: 'text',
                            rules: {
                                maxlength: 20
                            },
                            messages: {
                                maxlength: '最多20个字'
                            }
                        "></a>
                    </div>
                </div>

                <div class="form-item">
                    <label class="form-label">参观社区</label>
                    <div class="form-cont">
                        <i class="uricon-arrow-right ricon"></i>
                        <input type="hidden" id="workstageId" name="workstageId">
                        <a href="javascript:;" id="workstageId_dummy" class="readonly-text" data-toggle="modal" data-target="#workstageModal">请选择</a>
                    </div>
                </div>

                <div class="form-item">
                    <label class="form-label">参观日期</label>
                    <div class="form-cont">
                        <i class="uricon-arrow-right ricon"></i>
                        <input type="hidden" name="visitedDate" value="">
                        <input type="text" class="input-text" placeholder="请选择" id="visitedDate" data-target="visitedDate">
                    </div>
                </div>

                <div class="form-item">
                    <label class="form-label">参观时间</label>
                    <div class="form-cont">
                        <i class="uricon-arrow-right ricon"></i>
                        <input type="hidden" name="visitedTimeId" value="">
                        <input type="text" class="input-text" placeholder="请选择" id="visitedTime" data-target="visitedTimeId">
                    </div>
                </div>

                <div class="form-item">
                    <label class="form-label">参观人数</label>
                    <div class="form-cont">
                        <i class="uricon-arrow-right ricon"></i>
                        <input type="hidden" name="number" value="" placeholder="必填" />
                        <a href="javascript:;" class="readonly-text input-editor" data-target="#editor" data-options="
                            mode: 'input',
                            name: 'number',
                            label: '参观人数',
                            type: 'number',
                            rules: {
                               min:1,
                               max:10
                            },
                            messages: {
                                maxlength: '参观人数为10位以内的整数'
                            }
                        "></a>
                    </div>
                </div>

                <div class="form-item form-remark">
                    <label class="form-label">备注（选填）</label>
                    <div class="form-cont">
                        <div class="textarea-wrap sm-height">
                            <textarea name="remark" maxlength="200" placeholder="请填写备注说明..." class="resize-none"></textarea>
                        </div>
                        <div class="form-counter">
                            <span>0</span>/200
                        </div>
                    </div>
                </div>

            </div>
            <div class="form-position">
                <div class="form-action">
                    <button type="button" class="btn btn-primary" id="submit">提交申请</button>
                </div>
            </div>
        </form>
    </main>
    <!-- / main -->
</div>
<!-- / wrapper -->
<!-- 单行文本编辑器 -->
<section class="input-content" id="editor" role="parent">
    <header class="layer-header">
        <a href="javascript:;" class="edit-btn" role="close">取消</a>
        <a href="javascript:;" class="edit-btn input-content-save" role="save">保存</a>
    </header>
    <div class="layer-body">
        <form action class="form form-input-content">
            <div class="form-item">
                <input type="text" class="text" role="textfield">
            </div>
        </form>
    </div>
</section>
<!-- / 单行文本编辑器 -->

<!-- 社区 -->
<div class="modal form-modal" id="workstageModal" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <div class="scroller" id="workstageList">
                    <!-- 社区 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default reset">重置</button>
                <button type="button" class="btn btn-primary confirm">确定</button>
            </div>
        </div>
    </div>
</div>
<!--/ 社区 -->

<!-- 社区模板 -->
<script type="text/html" id="workstageTpl">
    {{each data as prop i}}
    <dl>
        <dt>{{i}}</dt>
        <dd>
            <ul data-col="2">
                {{each prop as item k}}
                <li data-id="{{item.id}}" data-visitTimeEnd="{{item.visitTimeEnd}}" data-visitTimeStart="{{item.visitTimeStart}}" data-province="{{item.provinceCode}}" data-city="{{item.cityCode}}" data-provinceName="{{item.provinceName}}" data-cityName="{{item.cityName}}" data-workstageName="{{item.stageName}}"><span>{{item.stageName}}</span></li>
                {{/each}}
            </ul>
        </dd>
    </dl>
    {{/each}}
</script>
<!-- / 社区模板 -->

<script src="/assets/public/visitor/scripts/visit.js"></script>
<script>
    $(function() {
        var $dom = $(document);
        var hasWorkstageId; //记录社区ID
        BaseForm.initReadonlyText();
        $dom
            .on('click', '.input-editor', function(e) {
                BaseForm.inputContent(this);
            })
            .on('click','#visitedTime',function () {
                hasWorkstageId = $('[name=workstageId]').val();
                var $el     = $('#visitedTime'),
                    target  = $el.attr('data-target'),
                    $target = target ? $(`[name=${target}]`) : null;

                if (!hasWorkstageId) {
                    $el.attr('readonly',true);
                    $el.blur();
                    UR.msg('请选择社区');
                    return false;
                }

                var $li = $('[data-id="' + hasWorkstageId + '"]');
                var start = $li.attr('data-visitTimeStart');
                var end = $li.attr('data-visitTimeEnd');
                var startHour = start.split(':')[0];
                var startMinute = start.split(':')[1];
                var endHour = end.split(':')[0];
                var endMinute = end.split(':')[1];

                var date   = new Date();
                var option = {
                    theme: 'android-holo-light',
                    mode: 'scroller',
                    display: 'modal',
                    lang: 'zh',
                    minDate:new Date(date.setHours(startHour,startMinute,0,0)),
                    maxDate: new Date(date.setHours(endHour,endMinute,0,0)),
                    minWidth:120,
                    buttons: [
                        'cancel', 'set'
                    ],
                    preset: 'time',
                    onBeforeShow: function(evevt,inst) {
                        UR.androidRefresh(false);
                    },
                    onCancel: function() {
                        UR.androidRefresh(true)
                    },
                    onSelect: function(event, inst) {
                        UR.androidRefresh(true)
                        $target && $target.val(inst.getVal());
                    },
                    onInit: function(inst) {
                        var $dummy = $('#visitedTime_dummy');
                        $dummy.attr('placeholder', $el.attr('placeholder'));
                        if ($target.val()) {
                            inst.setVal($target.val(), true);
                        } else {
                            $dummy.val('');
                        }
                    }
                }
                $el.mobiscroll().time(option);
                $el.mobiscroll('show');
            })
            .on(UR.click, '.confirm', function(e) {
                //处理用户选择时间后又更改社区
                var workstageId = $('[name=workstageId]').val();
                if(workstageId != hasWorkstageId){
                    $('#visitedTime').mobiscroll('clear');
                }
            })
        Form.ajaxPost({
            validator: {
                rules: {
                    name: {
                        required: true,
                        maxlength: 20,
                    },
                    mobile: {
                        required: true,
                        phone: true,
                    },
                    company: {
                        required: true,
                        maxlength: 23,
                    },
                    workstageId: {
                        required: true
                    },
                    visitedDate: {
                        required: true
                    },
                    visitedTimeId: {
                        required: true
                    },
                    number: {
                        required: true,
                        reg: /^[1-9]\d{0,9}$/,
                    },
                    remark: {
                        maxlength: 200
                    }
                },
                messages: {
                    name: {
                        required: '请填写预约人',
                        maxlength: '预约人最多填写20字',
                    },
                    mobile: {
                        required: '请填写联系电话',
                        phone: '请填写正确的手机号',
                    },
                    company: {
                        required: '请填写公司名称',
                        maxlength: '公司名称最多填写23字',
                    },
                    workstageId: {
                        required: '请选择参观社区'
                    },
                    visitedDate: {
                        required: '请选择参观日期'
                    },
                    visitedTimeId: {
                        required: '请选择参观时间'
                    },
                    number: {
                        required: '请填写参观人数',
                        reg: '参观人数为10位以内的整数'
                    },
                    remark: {
                        maxlength: '备注最大长度为200字'
                    }
                }
            },
            postUrl: '/workstageBookingVisit/save',
            postFormatted:function () {
                var mobiles = $('#mobile_dummy').html().split(' ');
                var workstageId = $('#workstageId').val();
                var $workstage = $('[data-id="' + workstageId + '"]');

                var data = {};
                data.name = $('[name="name"]').val();
                data.nationalCode = mobiles[0].substring(1);
                data.mobile = mobiles[1];
                data.province = $workstage.attr('data-province');
                data.provinceName = $workstage.attr('data-provinceName');
                data.city = $workstage.attr('data-city');
                data.cityName = $workstage.attr('data-cityName');
                data.workstageId = workstageId;
                data.workstageName = $workstage.attr('data-workstageName');
                data.personNum = $('[name="number"]').val();
                data.visitTime = $('[name="visitedDate"]').val();
                data.visitTimeStr = $('#visitedTime').val();
                data.companyName = $('[name="company"]').val();
                data.remark = $('[name="remark"]').val();
//                console.log(data);
                return data;

            },
            success: function (res) {
                UR.msg('预约成功');
                if (UR.isApp()) {
                    location.replace(UR.host + '');
                    return;
                }
                location.replace(UR.host + '');
            }
        });
    })
</script>


</body>
</html>
